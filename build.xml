<?xml version="1.0" encoding="UTF-8"?>

<project name="YAWIK" default="dist">

    <property file="./build.properties" />

    <property name="pkg.name" value="${phing.project.name}" override="false"/>
    <property name="version" value="0.12" override="true"/>
    <property name="builddir" value="./build/${pkg.name}-${version}"  override="false"/>
    <property name="vendordir" value="./vendor"  override="false"/>
    <property file="./build.properties" />
    
    <fileset id="core" dir="${project.basedir}">
        <include name="module/**" />
        <include name="public/**" />
        <include name="bin/console" />
        <include name="LICENCE" />
        <include name="README" />   
        <exclude name="public/js/*"/>
        <exclude name="**/YawikDemoSkin/**"/>
        <exclude name="**/*.mo"/>
        <exclude name="**/*.po"/>
        <exclude name="**/*.pot"/>
        <exclude name="**/language/_annotated_strings.php"/>
        <exclude name="public/fonts"/>
    </fileset>
    
    <fileset id="languages" dir="${project.basedir}/module">
      <include name="**/**.po"/>
    </fileset>
    
    <fileset id="bootstrap" dir="${vendordir}/twbs/bootstrap/dist">
        <include name="js/bootstrap.min.js" />
    </fileset>

    <fileset id="awesomefonts" dir="${vendordir}/fortawesome/font-awesome">
        <include name="fonts/*" />
    </fileset>

    <!-- ============================================  -->
    <!-- Target: prepare                               -->
    <!-- ============================================  -->
    <target name="prepare">
        <echo msg="Making directory ${builddir} " />
        <mkdir dir="${builddir}" />
        <mkdir dir="${builddir}/log" />
    </target>

    <!-- ============================================  -->
    <!-- Target: build                                 -->
    <!-- ============================================  -->
    <target name="build" depends="prepare">
        <echo msg="Copying core YAWIK to ${builddir} ..." />
        <copy todir="${builddir}">
            <fileset refid="core"/>
        </copy>
        <echo msg="Copying Bootstrap to ${builddir} ..." />
        <copy todir="${builddir}/public">
            <fileset refid="bootstrap"/>
        </copy>
        <echo msg="Copying Awesome Fonts to ${builddir} ..." />
        <copy todir="${builddir}/public">
            <fileset refid="awesomefonts"/>
        </copy>
        <echo msg="Compile locales ${locales} ..." />
        <foreach param="filename" absparam="absfilename" target="compile-po-file">
          <mapper type="regexp" from="^(.*)\.po" to="\1"/>
          <fileset refid="languages"/>
        </foreach>

        <echo msg="Generate Configuration ..." />
        <copy todir="${builddir}/config/autoload">
          <fileset dir="${project.basedir}">
           <include name="**/**.dist" />
           <exclude name="vendor/**" />
          </fileset>
          <mapper type="regexp" from="^(.*?)/([^/]+)\.dist" to="\2"/>
          <filterchain>
            <replacetokens begintoken="%%" endtoken="%%">
                <token key="mongo.host" value="${mongo.host}" />
                <token key="mongo.db" value="${mongo.db}" />
                <token key="mongo.port" value="${mongo.port}" />
            </replacetokens>
          </filterchain>
        </copy>
        
    </target>

    <!-- ============================================  -->
    <!-- (DEFAULT)  Target: dist                       -->
    <!-- ============================================  -->
    <target name="dist" depends="build">
        <echo msg="Creating archive..." />

        <tar destfile="./build/${pkg.name}-${version}.tar.gz" compression="gzip">
            <fileset dir="./build">
                <include name="*" />
            </fileset>
        </tar>

        <echo msg="Files copied and compressed in build directory OK!" />
    </target>
    
    <target name="compile-po-file">
         <echo msg="Translate ${filename}"/>
         <exec command="msgfmt -cv -o ${builddir}/module/${filename}.mo ${absfilename}" logoutput="true" dir="."/>        
    </target>
</project>
